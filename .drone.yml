---
kind: pipeline
type: aws
name: default

pool:
  use: windows

steps:
- name: check install
  commands:
  - 'type C:\ProgramData\Amazon\EC2-Windows\Launch\Log\UserdataExecution.log'

- name: Generate doc
  image: python
  commands:
  - 'pip install --upgrade pip'
  - 'pip install --upgrade markdown babel'
  - 'cp changelog.md doc\changelog.md'
  - 'cd doc'
  - 'python documentation_importer.py'
  - 'cd ..\src'
  - 'python ..\doc/generator.py'

- name: Build app
  image: python
  commands:
  - 'python -V'
  - 'python -m pip install --upgrade pip'
  - 'python -m pip install --upgrade -r requirements.txt'
  - 'python -m pip uninstall enum34 -y'
  - 'cd src'
  - 'python write_version_data.py'
  - 'python -m nuitka --mingw64 --standalone --enable-plugin=anti-bloat --noinclude-pytest-mode=nofollow --noinclude-setuptools-mode=nofollow --nofollow-import-to=numpy --nofollow-import-to=babel --nofollow-import-to=cx_freeze --nofollow-import-to=pil --include-data-file=../windows-dependencies/x86/oggenc2.exe=oggenc2.exe --include-data-file=../windows-dependencies/x86/bootstrap.exe=bootstrap.exe --include-data-file=app-configuration.defaults=app-configuration.defaults --include-data-dir=locales=locales --include-data-dir=documentation=documentation --include-data-dir=sounds=sounds --include-data-file=session.defaults=session.defaults --windows-disable-console --windows-file-description="Accessible VK Client for Windows" --windows-product-version=2021.12.14.0 --windows-file-version=2021.12.14.0 --windows-product-name="Socializer" --windows-company-name="MCV Software" --python-flag=no_site --assume-yes-for-downloads --remove-output "socializer.py"'
  - 'python ..\scripts\copy_missing_files.py'
  - 'cd ..'
  - 'mkdir artifacts'
  - 'cd scripts'
  - 'python prepare_zipversion.py'
  - 'cd ..'
  - 'move src\socializer.zip artifacts\socializer_x86.zip'
  - 'mv src/socializer.dist artifacts/socializer'
  - 'move src/installer.nsi artifacts'
  - 'python scripts/generate_update_file.py'
  - 'move *.json artifacts'